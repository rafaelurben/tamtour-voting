<div>
  <b>WebSocket: </b>
  @if (connected()) {
    <span style="color: green">Verbunden</span>
  } @else {
    <span style="color: red">Nicht verbunden</span>
  }
</div>

<div class="section-container">
  <h3>Viewers</h3>
  @if (viewerKeys() === null) {
    <app-spinner>Keys werden geladen...</app-spinner>
  } @else {
    <table class="full-width-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Status</th>
          <th>Ausgewählt</th>
        </tr>
      </thead>
      <tbody>
        @for (key of viewerKeys(); track key.id) {
          <tr>
            <td>{{ key.id }}</td>
            <td>{{ key.name }}</td>
            <td>{{ connectedViewerIds().includes(key.id) ? '✅' : '❌' }}</td>
            <td>
              {{ effectiveSelectedViewerIds().includes(key.id) ? '✅' : '❌' }}
              <input
                type="checkbox"
                [checked]="selectedViewerIds().includes(key.id)"
                [disabled]="!connectedViewerIds().includes(key.id)"
                (change)="toggleViewerSelection(key.id)" />
            </td>
          </tr>
        }
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4">
            Insgesamt {{ viewerKeys()?.length }} Viewer,
            {{ connectedViewerIds().length }} verbunden,
            {{ selectedViewerIds().length }} ausgewählt
          </td>
        </tr>
      </tfoot>
    </table>
  }
</div>

<div class="section-container">
  <h3>Befehle</h3>
  <form [formGroup]="commandForm" (ngSubmit)="submitForm()">
    <label>
      Aktion:
      <input formControlName="action" />
    </label>

    <label>
      Daten:
      <textarea formControlName="dataStr" rows="6"></textarea>
    </label>

    <app-button
      type="submit"
      [disabled]="
        commandForm.invalid || effectiveSelectedViewerIds().length === 0
      ">
      <span>Senden</span>
    </app-button>
  </form>

  <div class="button-row">
    <app-button
      [disabled]="effectiveSelectedViewerIds().length === 0"
      (trigger)="sendCommand('show')"
      >Show</app-button
    >
    <app-button
      [disabled]="effectiveSelectedViewerIds().length === 0"
      (trigger)="sendCommand('hide')"
      >Hide</app-button
    >
    <app-button
      [disabled]="effectiveSelectedViewerIds().length === 0"
      (trigger)="sendCommand('clear')"
      >Clear</app-button
    >
    <app-button
      [disabled]="effectiveSelectedViewerIds().length === 0"
      (trigger)="sendCommand('reveal_lower')"
      >Reveal 4.-n.</app-button
    >
    <app-button
      [disabled]="effectiveSelectedViewerIds().length === 0"
      (trigger)="sendCommand('reveal_podium')"
      >Reveal Podium</app-button
    >
  </div>
</div>

<div class="section-container">
  <h3>Kategorien (Datenquellen)</h3>
  @if (categories() === null) {
    <app-spinner>Kategorien werden geladen...</app-spinner>
  } @else if (categories().length === 0) {
    <p>Keine Kategorien gefunden.</p>
  } @else {
    <table class="full-width-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Resultate laden</th>
        </tr>
      </thead>
      <tbody>
        @for (category of categories(); track category.id) {
          <tr>
            <td>{{ category.id }}</td>
            <td>{{ category.name }}</td>
            <td>
              <app-button
                (trigger)="loadResults(category.id)"
                [loading]="
                  resultsLoading() && resultsLoadingId() === category.id
                "
                [disabled]="
                  resultsLoading() && resultsLoadingId() !== category.id
                ">
                <span>Laden</span>
              </app-button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  }
</div>
